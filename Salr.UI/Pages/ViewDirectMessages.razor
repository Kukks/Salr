@page "/dms/{pubkey}"
@layout FullLayout
@using NNostr.Client
@inject Db _db
@implements IAsyncDisposable



<MudPaper id="unique_id_scroll_section"
          Style="overflow: auto;height: calc(100vh - var(--mud-appbar-height) - 128px);">
    @if (Events is null)
    {
        <MudSkeleton Animation="Animation.Wave"/>
    }
    else
    {
        <ChatThreadItem EventId="@Pubkey" AllowReply="false" Depth="0" NestedMode="false"></ChatThreadItem>
        <MudSpacer></MudSpacer>
        <ChatThread Events="Events" AllowReply="false" NestedMode="false" ParentEvent="@Pubkey"></ChatThread>
    }

    <MudScrollToTop TopOffset="64" Selector="#unique_id_scroll_section">
        <MudFab Color="Color.Tertiary" Icon="@Icons.Filled.ArrowCircleUp"/>
    </MudScrollToTop>
</MudPaper>
<style>
    .chat-send-message, .chat-send-message .mud-toolbar.mud-toolbar-appbar, .chat-send-message .mud-toolbar.mud-toolbar-appbar form {
        height: 128px;
        
    }
</style>
<MudAppBar Fixed="true" Bottom="true" DisableGutters="true" Class="chat-send-message pl-6">

    <SendMessage OnSend="s => ConstructEvent(s)"></SendMessage>
</MudAppBar>
@code
{

    [CascadingParameter]
    public FullLayout Layout { get; set; }

    public partial class PageLinks
    {
        public static string DirectMessageLink(string pubkey)
        {
            return $"dms/{pubkey}";
        }
    }

    [Inject]
    public Db Db { get; set; }

    [Parameter]
    public string Pubkey { get; set; }

    public string[] Events { get; set; }

    public bool NestedMode { get; set; } = true;
    protected override async Task OnInitializedAsync()
    {
        Layout.Title = $"Direct Message {Pubkey}";
        await base.OnInitializedAsync();
        _filters = SalrDataExtensions.GetDirectMessageThreadFilters(Pubkey);
        await Db.Subscribe("direct-dm", _filters);
        Db.EventsReceived += EventsReceived;

        Events = GetEvents();
    }

    private void EventsReceived(object? sender, (string subscriptionId, NostrEvent[] events, Uri known) e)
    {
        if (e.subscriptionId == "direct-dm")
        {
            Events = GetEvents();
            InvokeAsync(StateHasChanged);
        }
    }

    private string[] GetEvents()
    {
        return Db.Events.Values.Filter(false, _filters)
            .Where(e => !NestedMode || !e.GetTaggedEvents().Any())
            .OrderBy(e => e.CreatedAt)
            .Select(e => e.Id)
            .ToArray();
    }
    public async Task ConstructEvent(string message, string replyTo = null)
    {
        var evt = new NostrEvent()
        {
            Content = message,
            CreatedAt = DateTimeOffset.UtcNow,
            Kind = 4,
            PublicKey = Db.PubKeyHex,
            Tags = new List<NostrEventTag>()
            {
                new NostrEventTag()
                {
                    TagIdentifier = "p",
                    Data = new List<string>()
                    {
                        Pubkey
                    }
                }
            }
        };
        if (replyTo is not null)
        {
            evt.Tags.Add(new NostrEventTag()
            {
                TagIdentifier = "e",
                Data = new List<string>()
                {
                    replyTo
                }
            });
        }
        evt.ComputeIdAndSign(Db.Key);
        await Db.SendEvent(evt);
    }

    public async ValueTask DisposeAsync()
    {
        Db.EventsReceived -= EventsReceived;
        await Db.Unsubscribe("direct-dm");
    }

    private NostrSubscriptionFilter[] _filters;

}